{% extends "base.html" %}

{% block content %}
<div class="bg-card rounded-lg border border-border shadow-sm">
  <div class="p-4 border-b border-border">
    <h3 class="font-semibold text-card-foreground">AI Model Predictions</h3>
  </div>
  
  <div class="p-4 space-y-4">
    {% if not patient %}
      <div class="text-center text-muted-foreground py-8">
        <i class="fas fa-brain fa-3x mx-auto mb-4"></i>
        <p>Select a patient to view model predictions</p>
      </div>
    {% else %}
      {% if model_predictions %}
        <div class="space-y-3">
          {% for model in model_predictions %}
            <div 
              class="flex items-center justify-between p-3 rounded-lg border {% if model.prediction >= 85 %}bg-destructive/10 border-destructive/20{% elif model.prediction >= 65 %}bg-warning/10 border-warning/20{% else %}bg-success/10 border-success/20{% endif %}"
            >
              <div class="flex items-center space-x-3">
                {% if model.model_name|lower|find:"logistic" %}
                  <i class="fas fa-brain"></i>
                {% elif model.model_name|lower|find:"forest" %}
                  <i class="fas fa-tree"></i>
                {% elif model.model_name|lower|find:"neural" %}
                  <i class="fas fa-network-wired"></i>
                {% else %}
                  <i class="fas fa-brain"></i>
                {% endif %}
                <div>
                  <p class="font-medium text-card-foreground" data-testid="text-model-name-{{ forloop.counter0 }}">
                    {{ model.model_name }}
                  </p>
                  <p class="text-xs text-muted-foreground">
                    {% if forloop.first %}Primary Model{% elif forloop.counter == 2 %}Secondary Model{% else %}Validation Model{% endif %}
                  </p>
                </div>
              </div>
              <div class="text-right">
                <p 
                  class="text-xl font-bold {% if model.prediction >= 85 %}text-destructive{% elif model.prediction >= 65 %}text-warning{% else %}text-success{% endif %}"
                  data-testid="text-model-prediction-{{ forloop.counter0 }}"
                >
                  {{ model.prediction|floatformat:0 }}%
                </p>
                <p class="text-xs text-muted-foreground">
                  Confidence: {{ model.confidence|mul:100|floatformat:0 }}%
                </p>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center text-muted-foreground py-8">
          <i class="fas fa-brain fa-3x mx-auto mb-4"></i>
          <p>No predictions available</p>
          <p class="text-xs">Run a test to generate predictions</p>
        </div>
      {% endif %}

      {% if latest_test %}
        <div class="pt-3 border-t border-border">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-card-foreground">Ensemble Prediction</span>
            <span 
              class="text-sm font-bold {% if ensemble_prediction >= 85 %}text-destructive{% elif ensemble_prediction >= 65 %}text-warning{% else %}text-success{% endif %}"
              data-testid="text-ensemble-prediction"
            >
              {{ ensemble_prediction|floatformat:0 }}%
            </span>
          </div>
          <div class="progress w-full h-3" style="width: {{ ensemble_prediction }}%;" data-testid="progress-ensemble-prediction"></div>
          <p class="text-xs text-muted-foreground mt-1">
            {% if ensemble_prediction >= 85 %}High sepsis risk detected{% elif ensemble_prediction >= 65 %}Moderate sepsis risk{% else %}Low sepsis risk{% endif %}
          </p>
        </div>
      {% endif %}

      <div class="grid grid-cols-2 gap-2">
        <form method="post" action="{% url 'retest_patient' patient.id %}">
          {% csrf_token %}
          <button 
            type="submit"
            class="btn"
            data-testid="button-retest-patient"
          >
            <i class="fas fa-redo mr-2"></i>
            Retest
          </button>
        </form>
        <button 
          class="btn secondary"
          data-testid="button-view-model-details"
        >
          <i class="fas fa-info-circle mr-2"></i>
          Details
        </button>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}